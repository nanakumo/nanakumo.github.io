{
    "version": "https://jsonfeed.org/version/1",
    "title": "この夏に🎇 • All posts by \"firefish\" tag",
    "description": "欢迎来到小倖的世界",
    "home_page_url": "https://nanakumo.github.io",
    "items": [
        {
            "id": "https://nanakumo.github.io/2023/08/24/%E8%8F%9C%E9%B8%9F%E7%BA%A7%E5%88%AB%E5%88%A9%E7%94%A8docker-compose%E6%90%AD%E5%BB%BAFirefish%E5%AE%9E%E4%BE%8B/",
            "url": "https://nanakumo.github.io/2023/08/24/%E8%8F%9C%E9%B8%9F%E7%BA%A7%E5%88%AB%E5%88%A9%E7%94%A8docker-compose%E6%90%AD%E5%BB%BAFirefish%E5%AE%9E%E4%BE%8B/",
            "title": "Firefish | 菜鸟级别利用docker-compose搭建Fedi实例",
            "date_published": "2023-08-24T12:49:19.316Z",
            "content_html": "<p>2023 年，随着 X 社媒（原 Twitter）的全面塌陷，越来越多的网友逃向了 Fediverse 开源社交平台，其中著名的有 Mastodon、Misskey 和 Pleroma。前阵子，随着<span class=\"exturl\" data-url=\"aHR0cHM6Ly9qb2luZmlyZWZpc2gub3Jn\"> Firefish</span> 的 <s>横空问世</s> （Misskey 的一个 fork），博主便也想着搭一个玩玩。博主是计算机零基础的小白 <s>（超级白的那种）</s> ，靠着广大热心网友先后搭起了一个 Misskey 实例和一个 Pleroma 实例，这一次，也多亏了大家的帮忙，磕磕绊绊地终于搭好了 Firefish 实例。趁着记忆还鲜明，赶紧记录一下搭建过程。</p>\n<span id=\"more\"></span>\n<h1 id=\"搭建过程\"><a class=\"anchor\" href=\"#搭建过程\">#</a> 搭建过程</h1>\n<p>因为是用<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXQuam9pbmZpcmVmaXNoLm9yZy9maXJlZmlzaC9maXJlZmlzaC8tL2Jsb2IvZGV2ZWxvcC9kb2NzL2RvY2tlci5tZA==\"> Docker-compose 搭建实例</span>，所以默认机器上是有 Docker 容器的。在此基础上，先在任意目录下新建 <code>docker-compose.yml</code>  文件。比如:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> /firefish <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">cd</span> /firefish</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">nano</span> docker-compose.yml</pre></td></tr></table></figure><p>然后<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXQuam9pbmZpcmVmaXNoLm9yZy9maXJlZmlzaC9maXJlZmlzaC8tL2Jsb2IvZGV2ZWxvcC9kb2NrZXItY29tcG9zZS55bWw=\">写入以下</span>：</p>\n<figure class=\"highlight yml\"><figcaption data-lang=\"YAML\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token key atrule\">web</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> registry.joinfirefish.org/firefish/firefish</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> firefish_web</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token punctuation\">-</span> db</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token punctuation\">-</span> redis</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">### Uncomment one of the following to use a search engine</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#     - meilisearch</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#     - sonic</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"3000:3000\"</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token punctuation\">-</span> calcnet</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#     - web</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token key atrule\">NODE_ENV</span><span class=\"token punctuation\">:</span> production</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token punctuation\">-</span> ./files<span class=\"token punctuation\">:</span>/firefish/files</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token punctuation\">-</span> ./.config<span class=\"token punctuation\">:</span>/firefish/.config<span class=\"token punctuation\">:</span>ro</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token key atrule\">redis</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> docker.io/redis<span class=\"token punctuation\">:</span>7.0<span class=\"token punctuation\">-</span>alpine</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> firefish_redis</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token punctuation\">-</span> calcnet</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      <span class=\"token punctuation\">-</span> ./redis<span class=\"token punctuation\">:</span>/data</pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> docker.io/postgres<span class=\"token punctuation\">:</span>12.2<span class=\"token punctuation\">-</span>alpine</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> firefish_db</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token punctuation\">-</span> calcnet</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token key atrule\">env_file</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token punctuation\">-</span> .config/docker.env</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      <span class=\"token punctuation\">-</span> ./db<span class=\"token punctuation\">:</span>/var/lib/postgresql/data</pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token comment\">### Only one of the below should be used.</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\">### Meilisearch is better overall, but resource-intensive. Sonic is a very light full text search engine.</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token comment\">#  meilisearch:</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\">#    container_name: meilisearch</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\">#    image: getmeili/meilisearch:v1.1.1</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">#    environment:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token comment\">#      - MEILI_ENV=$&#123;MEILI_ENV:-development&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">#    ports:</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token comment\">#      - \"7700:7700\"</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\">#    networks:</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token comment\">#      - calcnet</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token comment\">#    volumes:</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token comment\">#      - ./meili_data:/meili_data</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token comment\">#    restart: unless-stopped</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token comment\">#  sonic:</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token comment\">#    restart: unless-stopped</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token comment\">#    image: docker.io/valeriansaliou/sonic:v1.4.0</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token comment\">#    networks:</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token comment\">#      - calcnet</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token comment\">#    volumes:</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token comment\">#      - ./sonic:/var/lib/sonic/store</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token comment\">#      - ./sonic/config.cfg:/etc/sonic.cfg</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  <span class=\"token key atrule\">calcnet</span><span class=\"token punctuation\">:</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  <span class=\"token comment\">#  web:</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  <span class=\"token comment\">#    external:</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  <span class=\"token comment\">#      name: web</span></pre></td></tr></table></figure><blockquote>\n<p>注意：<br />\n如果此前搭建过 Misskey 的话，那么端口号 3000 应当是冲突的，这时候需要把 <code>web</code>  下面的 <code>ports</code>  改成其他端口，比如 <code>4000:4000</code> 。</p>\n</blockquote>\n<p>写完 <code>docker-compose.yml</code>  文件之后，需要在 firefish 的根目录下新建 <code>.config</code>  文件夹，在里头装入<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXQuam9pbmZpcmVmaXNoLm9yZy9maXJlZmlzaC9maXJlZmlzaC8tL2Jsb2IvZGV2ZWxvcC8uY29uZmlnL2V4YW1wbGUueW1s\"> default.yml</span> 和<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXQuam9pbmZpcmVmaXNoLm9yZy9maXJlZmlzaC9maXJlZmlzaC8tL2Jsb2IvZGV2ZWxvcC8uY29uZmlnL2RvY2tlcl9leGFtcGxlLmVudg==\"> docker.env</span> 这两个文件。</p>\n<p><strong>注意：</strong></p>\n<ol>\n<li>需要重命名：example.yml -&gt; default.yml &amp;&amp; docker_example.env -&gt; docker.env</li>\n<li>修改 default.yml 的内容：url -&gt; 自己的域名 &amp;&amp; db localhost -&gt; firefish_db &amp;&amp; redis localhost -&gt; redis <s>（备注：localhost 一定要修改，博主就是在这里卡了好久 QAQ）</s></li>\n<li>（可选）修改 default.yml 中的 port，如果端口有冲突的话。修改 db 的 user 和 pass，且两个文件一定要 match。</li>\n</ol>\n<p>待文件写入完毕之后，便可使容器上线： <code>docker-compose up -d</code></p>\n<h1 id=\"反向代理nginx\"><a class=\"anchor\" href=\"#反向代理nginx\">#</a> 反向代理：Nginx</h1>\n<p>这一部分的话，大概有很多种操作方法，我只写了我使用的一种：利用 Certbot 获取证书然后用 Nginx 反向代理。</p>\n<p><ins class=\"wavy\">首先去 DNS 服务商添加一条指向服务器 IP 的 A 记录。</ins> 然后回到服务器，先切换 root 用户： <code>sudo -i</code> 。因为要使用 Certbot 和 Nginx，所以默认服务器上有这两个东西。</p>\n<p>先<strong>获取证书</strong>，使用指令 <code>sudo certbot --nginx</code>  来获取证书，然后配置 Nginx。博主刚开始使用的是<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXQuam9pbmZpcmVmaXNoLm9yZy9maXJlZmlzaC9maXJlZmlzaC8tL2Jsb2IvZGV2ZWxvcC9maXJlZmlzaC5uZ2lueC5jb25m\"> firefish 的 Nginx 配置文件</span>，但是没有成功，后来经热心网友建议，使用<span class=\"exturl\" data-url=\"aHR0cHM6Ly9taXNza2V5LWh1Yi5uZXQvZW4vZG9jcy9hZG1pbi9uZ2lueC5odG1s\"> Misskey 的配置文件</span>试试，结果就成功了。</p>\n<p>我的配置文件如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># For WebSocket</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>map <span class=\"token variable\">$http_upgrade</span> <span class=\"token variable\">$connection_upgrade</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    default upgrade<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token string\">''</span>      close<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>proxy_cache_path /tmp/nginx_cache_firefish <span class=\"token assign-left variable\">levels</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>:2 <span class=\"token assign-left variable\">keys_zone</span><span class=\"token operator\">=</span>cache2:16m <span class=\"token assign-left variable\">max_size</span><span class=\"token operator\">=</span>1g <span class=\"token assign-left variable\">inactive</span><span class=\"token operator\">=</span>720m <span class=\"token assign-left variable\">use_temp_path</span><span class=\"token operator\">=</span>off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    listen <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>:80<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    server_name 你的域名<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\"># For SSL domain validation</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    root /var/www/html<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    location /.well-known/acme-challenge/ <span class=\"token punctuation\">&#123;</span> allow all<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    location /.well-known/pki-validation/ <span class=\"token punctuation\">&#123;</span> allow all<span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span> <span class=\"token builtin class-name\">return</span> <span class=\"token number\">301</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    listen <span class=\"token number\">443</span> ssl http2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    listen <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>:443 ssl http2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    server_name 你的域名<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>    ssl_session_timeout 1d<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    ssl_session_cache shared:ssl_session_cache:10m<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    ssl_session_tickets off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token comment\"># To use Let's Encrypt certificate</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    ssl_certificate /etc/letsencrypt/live/你的域名/fullchain.pem<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    ssl_certificate_key /etc/letsencrypt/live/你的域名/privkey.pem<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    <span class=\"token comment\"># To use Debian/Ubuntu's self-signed certificate (For testing or before issuing a certificate)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token comment\">#ssl_certificate     /etc/ssl/certs/ssl-cert-snakeoil.pem;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    <span class=\"token comment\">#ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token comment\"># SSL protocol settings</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    ssl_protocols TLSv1.2 TLSv1.3<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    ssl_prefer_server_ciphers off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    ssl_stapling on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    ssl_stapling_verify on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token comment\"># Change to your upload limit</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    client_max_body_size 80m<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"94\"></td><td><pre></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    <span class=\"token comment\"># Proxy to Node</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        proxy_pass http://127.0.0.1:6110<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        proxy_set_header Host <span class=\"token variable\">$host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        proxy_redirect off<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"109\"></td><td><pre></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        <span class=\"token comment\"># For WebSocket</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>        proxy_set_header Upgrade <span class=\"token variable\">$http_upgrade</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        proxy_set_header Connection <span class=\"token variable\">$connection_upgrade</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"117\"></td><td><pre></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        <span class=\"token comment\"># Cache settings</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>        proxy_cache cache2<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        proxy_cache_lock on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>        proxy_cache_use_stale updating<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        proxy_force_ranges on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>        add_header X-Cache <span class=\"token variable\">$upstream_cache_status</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"131\"></td><td><pre></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre></pre></td></tr><tr><td data-num=\"134\"></td><td><pre><span class=\"token comment\">#1location =/robots.txt &#123;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre></pre></td></tr><tr><td data-num=\"136\"></td><td><pre><span class=\"token comment\">#2    default_type text/html;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre></pre></td></tr><tr><td data-num=\"138\"></td><td><pre><span class=\"token comment\">#3    add_header Content-Type \"text/plain; charset=UTF-8\";</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre></pre></td></tr><tr><td data-num=\"140\"></td><td><pre><span class=\"token comment\">#4    return 200 \"User-agent: *\\nDisallow: /\\n\";</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre></pre></td></tr><tr><td data-num=\"142\"></td><td><pre><span class=\"token comment\">#5&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"145\"></td><td><pre></pre></td></tr><tr><td data-num=\"146\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>注意：</strong></p>\n<ol>\n<li>我修改了缓存地址，否则会和原来 Misskey 的缓存地址冲突：proxy_cache_path /tmp/nginx_cache_firefish</li>\n<li>将 cache1 改为了 cache2，共 2 处。</li>\n<li>端口号要和 docker-compose.yml 和 default.yml 的一致。</li>\n<li>需要修改 <code>你的域名</code> ，共 4 处。</li>\n</ol>\n<p>获取完证书和配置好 Nginx 文件之后，试着测试一下： <code>nginx -t</code> , 没有问题的话便是重载和重启 Nginx：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nginx <span class=\"token parameter variable\">-s</span> reload</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systemctl restart nginx</pre></td></tr></table></figure><p>（如果是第一次使用 Nginx 的话，不是 restart 而是 start）</p>\n<h1 id=\"痛苦的排错之路\"><a class=\"anchor\" href=\"#痛苦的排错之路\">#</a> 痛苦的排错之路</h1>\n<p>作为一个小白搭建实例免不了一路红灯 <s>（说的就是 error 呜呜）</s> ，总结了一下，出错原因要么是容器里的服务没有跑起来要么就是 Nginx 搞错了。</p>\n<ul>\n<li>Docker 容器</li>\n</ul>\n<ol>\n<li>首先 restart 一下容器： <code>docker-compose restart</code> ，这是解决 <code>502 error</code>  最好的办法 <s>（大佬说的）</s> 。</li>\n<li>然后看看 <code>docker ps</code>  里面的服务是不是都 up 了。没有的话可能就是配置错了，回去改改配置，最后 <code>docker-compose up -d</code>  来更新容器。</li>\n<li>实在不行，就通过 <code>docker compose logs web -f --tail 100</code>  来查看日志。</li>\n</ol>\n<ul>\n<li>Nginx 反代</li>\n</ul>\n<ol>\n<li>如果是 <code>502 error</code>  的话，如上所说先试试 <code>docker-compose restart</code> 。</li>\n<li>如果不行或是其他错误，先用 <code>nginx -t</code>  看看是否成功，没有成功的话可能就是配置文件写错了，注意<strong>端口号</strong>等等。</li>\n<li>test 没有问题的话，再看看 nginx 的 status： <code>sudo systemctl status nginx</code> 。</li>\n<li>清理缓存，再用 <code>service nginx reload</code>  重载，然后 <code>systemctl restart nginx</code>  重启。</li>\n</ol>\n<ul>\n<li>其他<br />\n可以用 <code>curl -v http://localhost:端口号</code> 看能不能拉取到信息。</li>\n</ul>\n",
            "tags": [
                "Fediverse",
                "Firefish",
                "Dokcer"
            ]
        }
    ]
}